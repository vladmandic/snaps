/*
  snaps
  homepage: <https://github.com/vladmandic/snaps>
  author: <https://github.com/vladmandic>'
*/

"use strict";var vt=Object.create;var xe=Object.defineProperty;var bt=Object.getOwnPropertyDescriptor;var St=Object.getOwnPropertyNames;var wt=Object.getPrototypeOf,$t=Object.prototype.hasOwnProperty;var Ft=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Ot=(e,t)=>{for(var r in t)xe(e,r,{get:t[r],enumerable:!0})},Ct=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of St(t))!$t.call(e,i)&&i!==r&&xe(e,i,{get:()=>t[i],enumerable:!(n=bt(t,i))||n.enumerable});return e};var L=(e,t,r)=>(r=e!=null?vt(wt(e)):{},Ct(t||!e||!e.__esModule?xe(r,"default",{value:e,enumerable:!0}):r,e));var Pe=Ft((Dr,at)=>{"use strict";var Mt=Object.create,$e=Object.defineProperty,Tt=Object.getOwnPropertyDescriptor,Qe=Object.getOwnPropertyNames,_t=Object.getPrototypeOf,Rt=Object.prototype.hasOwnProperty,xt=(e,t)=>function(){return t||(0,e[Qe(e)[0]])((t={exports:{}}).exports,t),t.exports},jt=(e,t)=>{for(var r in t)$e(e,r,{get:t[r],enumerable:!0})},Xe=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Qe(t))!Rt.call(e,i)&&i!==r&&$e(e,i,{get:()=>t[i],enumerable:!(n=Tt(t,i))||n.enumerable});return e},Q=(e,t,r)=>(r=e!=null?Mt(_t(e)):{},Xe(t||!e||!e.__esModule?$e(r,"default",{value:e,enumerable:!0}):r,e)),At=e=>Xe($e({},"__esModule",{value:!0}),e),Dt=xt({"node_modules/.pnpm/dayjs@1.11.4/node_modules/dayjs/dayjs.min.js"(e,t){(function(r,n){typeof e=="object"&&typeof t<"u"?t.exports=n():typeof define=="function"&&define.amd?define(n):(r=typeof globalThis<"u"?globalThis:r||self).dayjs=n()})(e,function(){"use strict";var r=1e3,n=6e4,i=36e5,c="millisecond",g="second",O="minute",C="hour",E="day",B="week",j="month",G="quarter",A="year",W="date",de="Invalid Date",Me=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,Te=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,pe={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},ne=function(p,a,o){var u=String(p);return!u||u.length>=a?p:""+Array(a+1-u.length).join(o)+p},yt={s:ne,z:function(p){var a=-p.utcOffset(),o=Math.abs(a),u=Math.floor(o/60),s=o%60;return(a<=0?"+":"-")+ne(u,2,"0")+":"+ne(s,2,"0")},m:function p(a,o){if(a.date()<o.date())return-p(o,a);var u=12*(o.year()-a.year())+(o.month()-a.month()),s=a.clone().add(u,j),d=o-s<0,f=a.clone().add(u+(d?-1:1),j);return+(-(u+(o-s)/(d?s-f:f-s))||0)},a:function(p){return p<0?Math.ceil(p)||0:Math.floor(p)},p:function(p){return{M:j,y:A,w:B,d:E,D:W,h:C,m:O,s:g,ms:c,Q:G}[p]||String(p||"").toLowerCase().replace(/s$/,"")},u:function(p){return p===void 0}},ie="en",q={};q[ie]=pe;var _e=function(p){return p instanceof he},ge=function p(a,o,u){var s;if(!a)return ie;if(typeof a=="string"){var d=a.toLowerCase();q[d]&&(s=d),o&&(q[d]=o,s=d);var f=a.split("-");if(!s&&f.length>1)return p(f[0])}else{var y=a.name;q[y]=a,s=y}return!u&&s&&(ie=s),s||!u&&ie},M=function(p,a){if(_e(p))return p.clone();var o=typeof a=="object"?a:{};return o.date=p,o.args=arguments,new he(o)},v=yt;v.l=ge,v.i=_e,v.w=function(p,a){return M(p,{locale:a.$L,utc:a.$u,x:a.$x,$offset:a.$offset})};var he=function(){function p(o){this.$L=ge(o.locale,null,!0),this.parse(o)}var a=p.prototype;return a.parse=function(o){this.$d=function(u){var s=u.date,d=u.utc;if(s===null)return new Date(NaN);if(v.u(s))return new Date;if(s instanceof Date)return new Date(s);if(typeof s=="string"&&!/Z$/i.test(s)){var f=s.match(Me);if(f){var y=f[2]-1||0,w=(f[7]||"0").substring(0,3);return d?new Date(Date.UTC(f[1],y,f[3]||1,f[4]||0,f[5]||0,f[6]||0,w)):new Date(f[1],y,f[3]||1,f[4]||0,f[5]||0,f[6]||0,w)}}return new Date(s)}(o),this.$x=o.x||{},this.init()},a.init=function(){var o=this.$d;this.$y=o.getFullYear(),this.$M=o.getMonth(),this.$D=o.getDate(),this.$W=o.getDay(),this.$H=o.getHours(),this.$m=o.getMinutes(),this.$s=o.getSeconds(),this.$ms=o.getMilliseconds()},a.$utils=function(){return v},a.isValid=function(){return this.$d.toString()!==de},a.isSame=function(o,u){var s=M(o);return this.startOf(u)<=s&&s<=this.endOf(u)},a.isAfter=function(o,u){return M(o)<this.startOf(u)},a.isBefore=function(o,u){return this.endOf(u)<M(o)},a.$g=function(o,u,s){return v.u(o)?this[u]:this.set(s,o)},a.unix=function(){return Math.floor(this.valueOf()/1e3)},a.valueOf=function(){return this.$d.getTime()},a.startOf=function(o,u){var s=this,d=!!v.u(u)||u,f=v.p(o),y=function(ee,D){var K=v.w(s.$u?Date.UTC(s.$y,D,ee):new Date(s.$y,D,ee),s);return d?K:K.endOf(E)},w=function(ee,D){return v.w(s.toDate()[ee].apply(s.toDate("s"),(d?[0,0,0,0]:[23,59,59,999]).slice(D)),s)},b=this.$W,T=this.$M,V=this.$D,U="set"+(this.$u?"UTC":"");switch(f){case A:return d?y(1,0):y(31,11);case j:return d?y(1,T):y(0,T+1);case B:var oe=this.$locale().weekStart||0,se=(b<oe?b+7:b)-oe;return y(d?V-se:V+(6-se),T);case E:case W:return w(U+"Hours",0);case C:return w(U+"Minutes",1);case O:return w(U+"Seconds",2);case g:return w(U+"Milliseconds",3);default:return this.clone()}},a.endOf=function(o){return this.startOf(o,!1)},a.$set=function(o,u){var s,d=v.p(o),f="set"+(this.$u?"UTC":""),y=(s={},s[E]=f+"Date",s[W]=f+"Date",s[j]=f+"Month",s[A]=f+"FullYear",s[C]=f+"Hours",s[O]=f+"Minutes",s[g]=f+"Seconds",s[c]=f+"Milliseconds",s)[d],w=d===E?this.$D+(u-this.$W):u;if(d===j||d===A){var b=this.clone().set(W,1);b.$d[y](w),b.init(),this.$d=b.set(W,Math.min(this.$D,b.daysInMonth())).$d}else y&&this.$d[y](w);return this.init(),this},a.set=function(o,u){return this.clone().$set(o,u)},a.get=function(o){return this[v.p(o)]()},a.add=function(o,u){var s,d=this;o=Number(o);var f=v.p(u),y=function(T){var V=M(d);return v.w(V.date(V.date()+Math.round(T*o)),d)};if(f===j)return this.set(j,this.$M+o);if(f===A)return this.set(A,this.$y+o);if(f===E)return y(1);if(f===B)return y(7);var w=(s={},s[O]=n,s[C]=i,s[g]=r,s)[f]||1,b=this.$d.getTime()+o*w;return v.w(b,this)},a.subtract=function(o,u){return this.add(-1*o,u)},a.format=function(o){var u=this,s=this.$locale();if(!this.isValid())return s.invalidDate||de;var d=o||"YYYY-MM-DDTHH:mm:ssZ",f=v.z(this),y=this.$H,w=this.$m,b=this.$M,T=s.weekdays,V=s.months,U=function(D,K,Re,me){return D&&(D[K]||D(u,d))||Re[K].slice(0,me)},oe=function(D){return v.s(y%12||12,D,"0")},se=s.meridiem||function(D,K,Re){var me=D<12?"AM":"PM";return Re?me.toLowerCase():me},ee={YY:String(this.$y).slice(-2),YYYY:this.$y,M:b+1,MM:v.s(b+1,2,"0"),MMM:U(s.monthsShort,b,V,3),MMMM:U(V,b),D:this.$D,DD:v.s(this.$D,2,"0"),d:String(this.$W),dd:U(s.weekdaysMin,this.$W,T,2),ddd:U(s.weekdaysShort,this.$W,T,3),dddd:T[this.$W],H:String(y),HH:v.s(y,2,"0"),h:oe(1),hh:oe(2),a:se(y,w,!0),A:se(y,w,!1),m:String(w),mm:v.s(w,2,"0"),s:String(this.$s),ss:v.s(this.$s,2,"0"),SSS:v.s(this.$ms,3,"0"),Z:f};return d.replace(Te,function(D,K){return K||ee[D]||f.replace(":","")})},a.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},a.diff=function(o,u,s){var d,f=v.p(u),y=M(o),w=(y.utcOffset()-this.utcOffset())*n,b=this-y,T=v.m(this,y);return T=(d={},d[A]=T/12,d[j]=T,d[G]=T/3,d[B]=(b-w)/6048e5,d[E]=(b-w)/864e5,d[C]=b/i,d[O]=b/n,d[g]=b/r,d)[f]||b,s?T:v.a(T)},a.daysInMonth=function(){return this.endOf(j).$D},a.$locale=function(){return q[this.$L]},a.locale=function(o,u){if(!o)return this.$L;var s=this.clone(),d=ge(o,u,!0);return d&&(s.$L=d),s},a.clone=function(){return v.w(this.$d,this)},a.toDate=function(){return new Date(this.valueOf())},a.toJSON=function(){return this.isValid()?this.toISOString():null},a.toISOString=function(){return this.$d.toISOString()},a.toString=function(){return this.$d.toUTCString()},p}(),He=he.prototype;return M.prototype=He,[["$ms",c],["$s",g],["$m",O],["$H",C],["$W",E],["$M",j],["$y",A],["$D",W]].forEach(function(p){He[p[1]]=function(a){return this.$g(a,p[0],p[1])}}),M.extend=function(p,a){return p.$i||(p(a,he,M),p.$i=!0),M},M.locale=ge,M.isDayjs=_e,M.unix=function(p){return M(1e3*p)},M.en=q[ie],M.Ls=q,M.p={},M})}}),et={};jt(et,{access:()=>Qt,accessFile:()=>ot,assert:()=>Zt,blank:()=>nr,client:()=>Xt,clientFile:()=>st,configure:()=>er,console:()=>dr,data:()=>sr,debug:()=>fr,error:()=>lr,fatal:()=>cr,header:()=>tr,headerJson:()=>rr,info:()=>ir,logFile:()=>it,options:()=>h,print:()=>H,ring:()=>ye,state:()=>or,tags:()=>I,timed:()=>qt,verbose:()=>ur,warn:()=>ar});at.exports=At(et);var tt=Q(require("os")),Z=Q(require("fs")),J=Q(require("path")),ce=Q(Dt()),je=10,We=(e=0)=>t=>`\x1B[${t+e}m`,Ue=(e=0)=>t=>`\x1B[${38+e};5;${t}m`,Je=(e=0)=>(t,r,n)=>`\x1B[${38+e};2;${t};${r};${n}m`;function Et(){let e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(let[r,n]of Object.entries(t)){for(let[i,c]of Object.entries(n))t[i]={open:`\x1B[${c[0]}m`,close:`\x1B[${c[1]}m`},n[i]=t[i],e.set(c[0],c[1]);Object.defineProperty(t,r,{value:n,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="\x1B[39m",t.bgColor.close="\x1B[49m",t.color.ansi=We(),t.color.ansi256=Ue(),t.color.ansi16m=Je(),t.bgColor.ansi=We(je),t.bgColor.ansi256=Ue(je),t.bgColor.ansi16m=Je(je),Object.defineProperties(t,{rgbToAnsi256:{value:(r,n,i)=>r===n&&n===i?r<8?16:r>248?231:Math.round((r-8)/247*24)+232:16+36*Math.round(r/255*5)+6*Math.round(n/255*5)+Math.round(i/255*5),enumerable:!1},hexToRgb:{value:r=>{let n=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(r.toString(16));if(!n)return[0,0,0];let{colorString:i}=n.groups;i.length===3&&(i=[...i].map(g=>g+g).join(""));let c=Number.parseInt(i,16);return[c>>16&255,c>>8&255,c&255]},enumerable:!1},hexToAnsi256:{value:r=>t.rgbToAnsi256(...t.hexToRgb(r)),enumerable:!1},ansi256ToAnsi:{value:r=>{if(r<8)return 30+r;if(r<16)return 90+(r-8);let n,i,c;if(r>=232)n=((r-232)*10+8)/255,i=n,c=n;else{r-=16;let C=r%36;n=Math.floor(r/36)/5,i=Math.floor(C/6)/5,c=C%6/5}let g=Math.max(n,i,c)*2;if(g===0)return 30;let O=30+(Math.round(c)<<2|Math.round(i)<<1|Math.round(n));return g===2&&(O+=60),O},enumerable:!1},rgbToAnsi:{value:(r,n,i)=>t.ansi256ToAnsi(t.rgbToAnsi256(r,n,i)),enumerable:!1},hexToAnsi:{value:r=>t.ansi256ToAnsi(t.hexToAnsi256(r)),enumerable:!1}}),t}var It=Et(),z=It,Ie=Q(require("process"),1),Pt=Q(require("os"),1),Ge=Q(require("tty"),1);function k(e,t=Ie.default.argv){let r=e.startsWith("-")?"":e.length===1?"-":"--",n=t.indexOf(r+e),i=t.indexOf("--");return n!==-1&&(i===-1||n<i)}var{env:$}=Ie.default,be;k("no-color")||k("no-colors")||k("color=false")||k("color=never")?be=0:(k("color")||k("colors")||k("color=true")||k("color=always"))&&(be=1);function Bt(){if("FORCE_COLOR"in $)return $.FORCE_COLOR==="true"?1:$.FORCE_COLOR==="false"?0:$.FORCE_COLOR.length===0?1:Math.min(Number.parseInt($.FORCE_COLOR,10),3)}function kt(e){return e===0?!1:{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}function Lt(e,{streamIsTTY:t,sniffFlags:r=!0}={}){let n=Bt();n!==void 0&&(be=n);let i=r?be:n;if(i===0)return 0;if(r){if(k("color=16m")||k("color=full")||k("color=truecolor"))return 3;if(k("color=256"))return 2}if(e&&!t&&i===void 0)return 0;let c=i||0;if($.TERM==="dumb")return c;if(Ie.default.platform==="win32"){let g=Pt.default.release().split(".");return Number(g[0])>=10&&Number(g[2])>=10586?Number(g[2])>=14931?3:2:1}if("CI"in $)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE","DRONE"].some(g=>g in $)||$.CI_NAME==="codeship"?1:c;if("TEAMCITY_VERSION"in $)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test($.TEAMCITY_VERSION)?1:0;if("TF_BUILD"in $&&"AGENT_NAME"in $)return 1;if($.COLORTERM==="truecolor")return 3;if("TERM_PROGRAM"in $){let g=Number.parseInt(($.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch($.TERM_PROGRAM){case"iTerm.app":return g>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test($.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test($.TERM)||"COLORTERM"in $?1:c}function Ve(e,t={}){let r=Lt(e,{streamIsTTY:e&&e.isTTY,...t});return kt(r)}var Nt={stdout:Ve({isTTY:Ge.default.isatty(1)}),stderr:Ve({isTTY:Ge.default.isatty(2)})},Yt=Nt;function zt(e,t,r){let n=e.indexOf(t);if(n===-1)return e;let i=t.length,c=0,g="";do g+=e.substr(c,n-c)+t+r,c=n+i,n=e.indexOf(t,c);while(n!==-1);return g+=e.slice(c),g}function Ht(e,t,r,n){let i=0,c="";do{let g=e[n-1]==="\r";c+=e.substr(i,(g?n-1:n)-i)+t+(g?`\r
`:`
`)+r,i=n+1,n=e.indexOf(`
`,i)}while(n!==-1);return c+=e.slice(i),c}var{stdout:Ke,stderr:qe}=Yt,Ae=Symbol("GENERATOR"),te=Symbol("STYLER"),ae=Symbol("IS_EMPTY"),Ze=["ansi","ansi","ansi256","ansi16m"],re=Object.create(null),Wt=(e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");let r=Ke?Ke.level:0;e.level=t.level===void 0?r:t.level},Ut=class{constructor(e){return rt(e)}},rt=e=>{let t=(...r)=>r.join(" ");return Wt(t,e),Object.setPrototypeOf(t,ue.prototype),t};function ue(e){return rt(e)}Object.setPrototypeOf(ue.prototype,Function.prototype);for(let[e,t]of Object.entries(z))re[e]={get(){let r=Se(this,Ee(t.open,t.close,this[te]),this[ae]);return Object.defineProperty(this,e,{value:r}),r}};re.visible={get(){let e=Se(this,this[te],!0);return Object.defineProperty(this,"visible",{value:e}),e}};var De=(e,t,r,...n)=>e==="rgb"?t==="ansi16m"?z[r].ansi16m(...n):t==="ansi256"?z[r].ansi256(z.rgbToAnsi256(...n)):z[r].ansi(z.rgbToAnsi(...n)):e==="hex"?De("rgb",t,r,...z.hexToRgb(...n)):z[r][e](...n),Jt=["rgb","hex","ansi256"];for(let e of Jt){re[e]={get(){let{level:r}=this;return function(...n){let i=Ee(De(e,Ze[r],"color",...n),z.color.close,this[te]);return Se(this,i,this[ae])}}};let t="bg"+e[0].toUpperCase()+e.slice(1);re[t]={get(){let{level:r}=this;return function(...n){let i=Ee(De(e,Ze[r],"bgColor",...n),z.bgColor.close,this[te]);return Se(this,i,this[ae])}}}}var Gt=Object.defineProperties(()=>{},{...re,level:{enumerable:!0,get(){return this[Ae].level},set(e){this[Ae].level=e}}}),Ee=(e,t,r)=>{let n,i;return r===void 0?(n=e,i=t):(n=r.openAll+e,i=t+r.closeAll),{open:e,close:t,openAll:n,closeAll:i,parent:r}},Se=(e,t,r)=>{let n=(...i)=>Vt(n,i.length===1?""+i[0]:i.join(" "));return Object.setPrototypeOf(n,Gt),n[Ae]=e,n[te]=t,n[ae]=r,n},Vt=(e,t)=>{if(e.level<=0||!t)return e[ae]?"":t;let r=e[te];if(r===void 0)return t;let{openAll:n,closeAll:i}=r;if(t.includes("\x1B"))for(;r!==void 0;)t=zt(t,r.close,r.open),r=r.parent;let c=t.indexOf(`
`);return c!==-1&&(t=Ht(t,i,n,c)),n+t+i};Object.defineProperties(ue.prototype,re);var jr=ue(),Ar=ue({level:qe?qe.level:0}),nt=require("console"),N=new Ut({level:2}),ye=[],h={dateFormat:"YYYY-MM-DD HH:mm:ss",ringLength:100,console:!0,timeStamp:!0},m={logFile:!1,accessFile:!1,clientFile:!1,logStream:void 0,accessStream:void 0,clientStream:void 0},I={blank:"",continue:":     ",info:N.cyan("INFO: "),warn:N.yellow("WARN: "),data:N.green("DATA: "),error:N.red("ERROR:"),fatal:N.bold.red("FATAL:"),assert:N.italic.bold.red("ASSERT:"),timed:N.magentaBright("TIMED:"),state:N.magenta("STATE:"),verbose:N.bgGray.yellowBright("VERB: "),debug:N.bgGray.redBright("DEBUG:"),console:N.gray("CONSOLE:")},ve={showHidden:!1,depth:5,colors:!0,showProxy:!0,maxArrayLength:1024,maxStringLength:10240,breakLength:200,compact:64,sorted:!1,getters:!1},we=new nt.Console({stdout:process.stdout,stderr:process.stderr,ignoreErrors:!0,inspectOptions:ve});function Kt(e){let t="";try{t=JSON.stringify(e)}catch{}return t}function le(...e){let t="";for(let r of e)t+=typeof r=="object"?Kt(r):r,t+=" ";return t}function H(...e){let t=(0,ce.default)(Date.now()).format(h.dateFormat);h.console&&(h.timeStamp?we.log(t,...e):we.log(...e))}function it(e){typeof e=="string"&&(h.logFile=e,m.logFile=!0,m.logStream=Z.createWriteStream(J.resolve(h.logFile||""),{flags:"a"}),m.logStream&&m.logStream.on("error",t=>{H(I.error,"Cannot open application log",h.logFile,t),m.logFile=!1}))}function ot(e){typeof e=="string"&&(h.accessFile=e,m.accessFile=!0,m.accessStream=Z.createWriteStream(J.resolve(h.accessFile),{flags:"a"}),m.accessStream&&m.accessStream.on("error",t=>{H(I.error,"Cannot open application log",h.accessFile,t),m.accessFile=!1}))}function st(e){typeof e=="string"&&(h.clientFile=e,m.clientFile=!0,m.clientStream=Z.createWriteStream(J.resolve(h.clientFile),{flags:"a"}),m.clientStream&&m.clientStream.on("error",t=>{H(I.error,"Cannot open application log",h.clientFile,t),m.clientFile=!1}))}async function qt(e,...t){arguments.length<2&&(t=[e],e=process.hrtime.bigint());let r=process.hrtime.bigint(),n=0;try{n=parseInt((r-e).toString())}catch{}n=Math.round(n/1e6);let i=(0,ce.default)(Date.now()).format(h.dateFormat);h.console&&we.log(i,I.timed,`${n.toLocaleString()} ms`,...t),m.logFile&&m.logStream&&m.logStream.write(`${I.timed} ${i} ${n.toLocaleString()} ms ${le(...t)}
`)}async function R(e,...t){let r=(0,ce.default)(Date.now()).format(h.dateFormat);I[e]?H(I[e],...t):H(...t),m.logFile&&m.logStream&&m.logStream.write(`${r} ${I[e]} ${le(...t)}
`),ye.push({tag:e,time:r,msg:le(...t)}),ye.length>h.ringLength&&ye.shift()}async function Zt(e,t,...r){e!==t&&R("assert",...r,{res:e,exp:t})}async function Qt(...e){let t=(0,ce.default)(Date.now()).format(h.dateFormat);m.accessFile&&m.accessStream&&m.accessStream.write(`${t} ${le(...e)}
`)}async function Xt(...e){let t=(0,ce.default)(Date.now()).format(h.dateFormat);m.clientFile&&m.clientStream&&m.clientStream.write(`${t} ${le(...e)}
`)}function er(e){!e||(e.dateFormat&&(h.dateFormat=e.dateFormat),e.ringLength&&(h.ringLength=e.ringLength),e.logFile&&it(e.logFile),e.accessFile&&ot(e.accessFile),e.clientFile&&st(e.clientFile),e.inspect&&(ve={...ve,...e.inspect}),we=new nt.Console({stdout:process.stdout,stderr:process.stderr,ignoreErrors:!0,inspectOptions:ve}))}function tr(){let e="./package.json";if(!Z.existsSync(e))return;let t=JSON.parse(Z.readFileSync(e).toString());process.title=t.name,R("info",t.name,"version",t.version),R("info","User:",tt.userInfo().username,"Platform:",process.platform,"Arch:",process.arch,"Node:",process.version),h.logFile&&m.logFile&&H(I.state,"Application log:",J.resolve(h.logFile)),h.accessFile&&m.accessFile&&H(I.state,"Access log:",J.resolve(h.accessFile)),h.clientFile&&m.clientFile&&H(I.state,"Client log:",J.resolve(h.clientFile))}function rr(){let e="./package.json";if(!Z.existsSync(e))return;let t=JSON.parse(Z.readFileSync(e).toString());process.title=t.name,R("info",{application:t.name,version:t.version}),R("info",{user:tt.userInfo().username,platform:process.platform,arch:process.arch,node:process.version}),(h.logFile||h.accessFile||h.clientFile)&&H(I.state,{log:J.resolve(h.logFile||""),access:J.resolve(h.accessFile||""),client:J.resolve(h.clientFile||"")})}var nr=(...e)=>R("blank",...e),ir=(...e)=>R("info",...e),or=(...e)=>R("state",...e),sr=(...e)=>R("data",...e),ar=(...e)=>R("warn",...e),lr=(...e)=>R("error",...e),cr=(...e)=>R("fatal",...e),ur=(...e)=>R("verbose",...e),fr=(...e)=>R("debug",...e),dr=(...e)=>R("console",...e)});var Y=L(require("fs")),ht=L(require("path")),ze=L(require("sharp")),_=L(Pe());var F=L(require("fs")),Fe=L(require("zlib")),ct=L(require("http")),ut=L(require("http2")),S=L(require("path")),P=L(Pe()),l,pr={".html":"text/html; charset=utf-8",".js":"text/javascript; charset=utf-8",".css":"text/css; charset=utf-8",".json":"application/json; charset=utf-8",".png":"image/png",".jpg":"image/jpeg",".gif":"image/gif",".ico":"image/x-icon",".svg":"image/svg+xml",".wav":"audio/wav",".mp4":"video/mp4",".woff":"font/woff",".woff2":"font/woff2",".ttf":"font/ttf",".wasm":"application/wasm",".webmanifest":"application/manifest+json"};function gr(e){e=e.split(/[?#]/)[0];let t={ok:!1,stat:null,file:"",redirect:null},r=i=>(t.file=i,F.existsSync(i)&&(t.stat=F.statSync(i),t.stat.isFile())?(t.ok=!0,!0):!1),n=i=>(t.file=i,F.existsSync(i)&&(t.stat=F.statSync(i),t.stat.isDirectory())?(t.ok=!0,!0):!1);return new Promise(i=>{n(S.join(process.cwd(),l.documentRoot,e))&&r(S.join(process.cwd(),l.documentRoot,e,l.defaultFile))?(t.redirect=S.join(e,l.defaultFile),i(t)):(r(S.join(process.cwd(),l.documentRoot,e))||r(S.join(process.cwd(),l.documentRoot,e,l.defaultFile))||r(S.join(process.cwd(),l.documentRoot,l.defaultFolder,e))||r(S.join(process.cwd(),l.documentRoot,l.defaultFolder,e,l.defaultFile))||n(S.join(process.cwd(),l.documentRoot,e))||n(S.join(process.cwd(),l.documentRoot,l.defaultFolder,e))||n(S.join(S.dirname(S.join(process.cwd(),l.documentRoot,l.defaultFolder,e,l.defaultFile,e)))),i(t))})}async function lt(e,t){let r=decodeURI(e.url);gr(r).then(n=>{let i=(e.headers.forwarded||"").match(/for="\[(.*)\]:/),c=(Array.isArray(i)?i[1]:null)||e.headers["x-forwarded-for"]||e.ip||e.socket.remoteAddress,g=e.headers[":scheme"]?.toUpperCase()||"HTTP";if(!n||!n.ok||!n.stat)t.writeHead(404,{"Content-Type":"text/html; charset=utf-8"}),t.end(`Error 404: Not Found
`,"utf-8"),P.warn(`${g}:`,{method:e.method,ver:e.httpVersion,status:t.statusCode,url:r,remote:c});else if(n.redirect)t.writeHead(301,{Location:n.redirect}),t.end(),P.data(`${g}:`,{method:e.method,ver:e.httpVersion,status:t.statusCode,url:r,redirect:n.redirect,remote:c});else{let O=encodeURIComponent(n.file).replace(/\*/g,"").replace(/\?/g,"").replace(/%2F/g,"/").replace(/%40/g,"@").replace(/%20/g," ").replace(/%3A/g,":").replace(/%5C/g,"\\");if(n?.stat?.isFile()){let C=String(S.extname(O)).toLowerCase(),E=pr[C]||"application/octet-stream",B=e.headers.range,j=B?.replace("bytes=","").split("-")||[0,n.stat.size-1],G=parseInt(j[0]||0),A=parseInt(j[1]||n.stat.size-1),W=e.headers["accept-encoding"]?e.headers["accept-encoding"].includes("br"):!1,de=B?{"Content-Range":"bytes "+G+"-"+A+"/"+n.stat.size,"Accept-Ranges":"bytes","Content-Length":A-G+1}:{},Me=l.cors?{"Cross-Origin-Embedder-Policy":"require-corp","Cross-Origin-Opener-Policy":"same-origin"}:{};t.writeHead(B?206:200,{"Content-Size":n.stat.size,"Content-Language":"en","Content-Type":E,"Content-Encoding":W&&!B?"br":"","Last-Modified":n.stat.mtime.toUTCString(),"Cache-Control":"no-cache","X-Content-Type-Options":"nosniff","Content-Security-Policy":"media-src 'self' http: https: data:","`Service-Worker-Allowed":"/",...Me,...de});let Te=Fe.createBrotliCompress({params:{[Fe.constants.BROTLI_PARAM_QUALITY]:5}}),pe=B?F.createReadStream(O,{start:G,end:A}):F.createReadStream(O);!W||B?pe.pipe(t):pe.pipe(Te).pipe(t);let ne=B?{range:{start:G,end:A,size:A-G+1}}:{};P.data(`${g}:`,{method:e.method,ver:e.httpVersion,status:t.statusCode,mime:E.replace("; charset=utf-8",""),size:n.stat.size,...ne,url:r,remote:c})}if(n?.stat?.isDirectory()){t.writeHead(200,{"Content-Language":"en","Content-Type":"application/json; charset=utf-8","Last-Modified":n.stat.mtime,"Cache-Control":"no-cache","X-Content-Type-Options":"nosniff"});let C=F.readdirSync(O);C=C.map(E=>S.join(decodeURI(e.url),E)),t.end(JSON.stringify(C),"utf-8"),P.data(`${g}:`,{method:e.method,ver:e.httpVersion,status:t.statusCode,mime:"directory/json",size:n.stat.size,url:r,remote:c})}}})}async function ft(e){if(l={insecureHTTPParser:!1,...e},F.existsSync(l.sslKey)&&F.existsSync(l.sslCrt))l.key=F.readFileSync(l.sslKey),l.cert=F.readFileSync(l.sslCrt);else try{let t=require.resolve("@vladmandic/build");l.sslKey=S.join(S.dirname(t),"..",l.sslKey),l.sslCrt=S.join(S.dirname(t),"..",l.sslCrt),l.key=F.existsSync(l.sslKey)?F.readFileSync(l.sslKey):null,l.cert=F.existsSync(l.sslCrt)?F.readFileSync(l.sslCrt):null}catch{}(!l.key||!l.cert)&&P.warn("cannot read SSL certificate"),l.httpPort&&l.httpPort>0&&await new Promise(t=>{let r=ct.createServer(l,lt);r.on("listening",()=>{P.state("http:",{port:l.httpPort,root:l.documentRoot}),t(!0)}),r.on("error",n=>{P.error("http:",n.message||n),t(!1)}),r.listen(l.httpPort)}),l.httpsPort&&l.httpsPort>0&&l.key&&l.cert&&await new Promise(t=>{let r=ut.createSecureServer(l,lt);r.on("listening",()=>{P.state("https:",{port:l.httpsPort,root:l.documentRoot,sslKey:l.sslKey,sslCrt:l.sslCrt}),t(!0)}),r.on("error",n=>{P.error("https:",n.message||n),t(!1)}),r.listen(l.httpsPort)})}var pt="@vladmandic/snaps",gt="0.1.0";var Be={};Ot(Be,{default:()=>Or,defaultFile:()=>wr,defaultFolder:()=>Sr,documentRoot:()=>br,folder:()=>X,httpPort:()=>yr,httpsPort:()=>vr,index:()=>ke,interval:()=>Le,log:()=>Oe,quality:()=>Ye,resizeWidth:()=>Ne,secrets:()=>fe,sslCrt:()=>Fr,sslKey:()=>$r});var fe="secrets.json",Oe="snaps.log",X="images",ke="images/index.json",Le=60,yr=8e3,vr=8001,br=".",Sr="/",wr="public/index.html",$r="node_modules/@vladmandic/build/cert/https.key",Fr="node_modules/@vladmandic/build/cert/https.crt",Ne=1280,Ye=60,Or={secrets:fe,log:Oe,folder:X,index:ke,interval:Le,httpPort:yr,httpsPort:vr,documentRoot:br,defaultFolder:Sr,defaultFile:wr,sslKey:$r,sslCrt:Fr,resizeWidth:Ne,quality:Ye};var Ce={},Cr=e=>{let t=Y.readdirSync(X),r=0;for(let n of t){if(!n.startsWith(`${e}-`))continue;let i=Number(n.replace(`${e}-`,"").split(".")[0]);i>r&&(r=i)}return r++,_.info("sequence:",{name:e,start:r}),r},mt=()=>{let e=new Date,t=r=>r.toString().padStart(2,"0");return`${e.getFullYear()}:${t(e.getMonth()+1)}:${t(e.getDate())} ${t(e.getHours())}:${t(e.getMinutes())}:${t(e.getSeconds())}`},Mr=()=>({IFD0:{Software:`${pt} ${gt}`},IFD2:{DateTimeOriginal:mt(),OffsetTime:(new Date().getTimezoneOffset()/60).toString()}});async function Tr(e,t){let r=await t.blob();if(r.type!=="image/jpeg"&&r.type!=="image/png"){_.warn("unrecognized file type:",{name:e,data:r});return}Ce[e]||(Ce[e]=Cr(e));let n=Ce[e].toString().padStart(5,"0"),i=ht.join(X,`${e}-${n}.jpg`),c=new Uint8Array(await r.arrayBuffer()),g=await(0,ze.default)(c).metadata(),O=await(0,ze.default)(c).normalize().resize(Ne,null).jpeg({quality:Ye,mozjpeg:!0}).withMetadata({exif:Mr()}).toFile(i);Ce[e]++;let C={seq:n,file:i,date:new Date,input:{name:e,size:r.size,type:r.type,resolution:[g.width,g.height]},output:{size:O.size,resolution:[O.width,O.height]}};Y.appendFileSync(ke,JSON.stringify(C)+`
`),_.data("image:",C)}async function _r(e){for(let[t,r]of Object.entries(e))fetch(r).then(n=>Tr(t,n)).catch(n=>_.warn("fetch:",{host:n?.cause?.hostname,syscall:n?.cause?.syscall,code:n?.cause?.code}))}async function Rr(){_.configure({inspect:{breakLength:500}}),Oe?.length>0&&_.logFile(Oe),_.headerJson(),Y.existsSync(fe)||(_.error("cannot read secrets:",fe),process.exit(1)),(!Y.existsSync(X)||!Y.statSync(X).isDirectory())&&(_.error("desitnation folder does not exist:",X),process.exit(1));let e=Y.readFileSync(fe,"utf8"),t=JSON.parse(e);await ft(Be),setInterval(()=>_r(t),Le*1e3),mt()}Rr();
//# sourceMappingURL=snaps.js.map
